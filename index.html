<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æ‘˜è®° My Excerpts</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #121620;
      --muted: #7c8799;
      --text: #e8eef8;
      --brand: #7aa2ff;
      --accent: #63e6be;
      --danger: #ff6b6b;
      --border: #1f2633;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background: linear-gradient(180deg, #0b0d12, #0b0d12 60%, #0e1420); color: var(--text); }
    .app { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }
    aside { background: linear-gradient(180deg, #0f1420, #0c1018); border-right: 1px solid var(--border); padding: 14px 12px; overflow: auto; }
    main { display: grid; grid-template-rows: auto 1fr; }
    header { display:flex; gap: 12px; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--border); background: rgba(18,22,32,0.6); backdrop-filter: blur(6px); position: sticky; top:0; z-index: 1; }
    .title { font-weight: 800; letter-spacing: 0.2px; }
    .brand { color: var(--brand); }
    .toolbar { margin-left: auto; display:flex; gap: 8px; }
    .btn { border: 1px solid var(--border); background: #141a26; color: var(--text); padding: 8px 10px; border-radius: 10px; cursor: pointer; transition: .15s ease; }
    .btn:hover { transform: translateY(-1px); border-color: #2a3345; }
    .btn.primary { background: linear-gradient(180deg, #1a2333, #151e2b); border-color: #2b3952; }
    .btn.ghost { background: transparent; }
    .danger { color: var(--danger); }

    .searchbar { display: grid; grid-template-columns: 1fr 160px 140px; gap: 10px; padding: 12px 18px; border-bottom: 1px solid var(--border); background: #0f141f; }
    input, select, textarea { background: #0e1320; border: 1px solid var(--border); color: var(--text); border-radius: 10px; padding: 10px 12px; outline: none; }
    input::placeholder, textarea::placeholder { color: #6b778d; }

    .lists { display: grid; grid-template-columns: 1fr; height: 100%; overflow: hidden; }
    .content { overflow: auto; padding: 10px 18px 40px; }

    .book-card { border: 1px solid var(--border); background: #0f1420; padding: 8px; margin: 6px 0; border-radius: 12px; cursor: pointer; transition: .15s ease; }
    .book-card:hover { border-color: #263149; }
    .book-card.active { outline: 2px solid var(--brand); }
    .book-title { font-weight: 700; }
    .muted { color: var(--muted); font-size: 12px; }

    .note { border: 1px solid var(--border); background: linear-gradient(180deg,#111828, #121829); padding: 14px; margin: 10px 0; border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
    .note-head { display:flex; align-items:center; gap: 10px; margin-bottom: 8px; }
    .tag { font-size: 12px; padding: 3px 8px; border:1px solid #2a3347; border-radius: 999px; color: #a9b6d1; }
    .tags { display:flex; flex-wrap: wrap; gap: 6px; }
    .note-meta { font-size: 12px; color: var(--muted); }
    .note-text { line-height: 1.6; white-space: pre-wrap; }

    .section-title { margin: 14px 0 4px; font-size: 13px; text-transform: uppercase; letter-spacing: .08em; color: #9fb2d9; }

    .book-count { background: #131a29; border: 1px solid var(--border); padding: 6px 8px; border-radius: 10px; font-size: 12px; margin-left:auto; color:#9fb2d9 }

    .divider { height: 1px; background: var(--border); margin: 10px 0; }

    .empty { color: #93a0ba; text-align: center; margin-top: 40px; }

    .footer { text-align: center; color: var(--muted); font-size: 12px; padding: 12px; }

    /* Modal */
    dialog { border: 1px solid var(--border); background: #0f1420; color: var(--text); border-radius: 14px; width: min(720px, 92vw); }
    dialog::backdrop { background: rgba(0,0,0,0.55); backdrop-filter: blur(2px); }
    .modal-head { display:flex; align-items:center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .modal-body { padding: 14px; display: grid; gap: 10px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row { display:flex; gap: 10px; align-items:center; }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="section-title">ä¹¦ç›® Books</div>
      <div id="bookList"></div>
      <div class="divider"></div>
      <div class="section-title">æ•°æ® Data</div>
      <div class="row">
        <button class="btn" id="btnImport">å¯¼å…¥JSON</button>
        <button class="btn" id="btnExport">å¯¼å‡ºJSON</button>
      </div>
      <p class="muted" style="margin-top:8px">é™æ€ç«™ç‚¹æ— æ³•ç›´æ¥å†™æ–‡ä»¶ï¼šæ–°å¢/ç¼–è¾‘å°†å­˜å…¥æµè§ˆå™¨ LocalStorageï¼Œå¹¶å¯â€œå¯¼å‡ºJSONâ€ä¸‹è½½åè¦†ç›–æœåŠ¡å™¨ä¸Šçš„ <code>notes.json</code>ã€‚</p>
      <div class="divider"></div>
      <div class="section-title">å¿«æ·è§†å›¾</div>
      <div class="row" style="flex-wrap:wrap">
        <button class="btn ghost" data-view="all">å…¨éƒ¨</button>
        <button class="btn ghost" data-view="recent">æœ€è¿‘7å¤©</button>
        <button class="btn ghost" data-view="month">æœ¬æœˆ</button>
      </div>
    </aside>

    <main>
      <header>
        <div class="title">ğŸ“š æˆ‘çš„æ‘˜è®° <span class="brand">My Excerpts</span></div>
        <div class="toolbar">
          <button class="btn primary" id="btnNew">â• æ–°å¢æ‘˜è®°</button>
          <button class="btn" id="btnNewBook">ğŸ“˜ æ–°å¢ä¹¦ç›®</button>
        </div>
      </header>

      <div class="searchbar">
        <input id="q" placeholder="æœç´¢ï¼šå†…å®¹ / æ ‡ç­¾ / ä¹¦å / ä½œè€…... (æ”¯æŒ #æ ‡ç­¾)" />
        <select id="sort">
          <option value="newest">æŒ‰æ—¶é—´ï¼šæœ€æ–°â†’æœ€æ—§</option>
          <option value="oldest">æŒ‰æ—¶é—´ï¼šæœ€æ—§â†’æœ€æ–°</option>
        </select>
        <select id="group">
          <option value="none">åˆ†ç»„ï¼šæ— </option>
          <option value="date">åˆ†ç»„ï¼šæ—¥æœŸ</option>
          <option value="book">åˆ†ç»„ï¼šä¹¦å</option>
        </select>
      </div>

      <div class="lists">
        <div class="content" id="content"></div>
      </div>
      <div class="footer">è½»é‡ JSON é©±åŠ¨ Â· å¯æœç´¢ Â· å¯æŒ‰ä¹¦æµè§ˆ Â· æ—¶é—´è®°å½• Â· æœ¬åœ°æ–°å¢/å¯¼å‡º</div>
    </main>
  </div>

  <!-- æ–°å¢æ‘˜è®° Modal -->
  <dialog id="dlgNote">
    <div class="modal-head">
      <div>æ–°å¢æ‘˜è®°</div>
      <button class="btn" onclick="dlgNote.close()">å…³é—­</button>
    </div>
    <form class="modal-body" method="dialog">
      <div class="grid-2">
        <div>
          <label>æ‰€å±ä¹¦ç›®</label>
          <select id="formNoteBook"></select>
        </div>
        <div>
          <label>é¡µç /æ¥æº (å¯é€‰)</label>
          <input id="formSource" placeholder="å¦‚ p.123 / ç« èŠ‚å" />
        </div>
      </div>
      <div>
        <label>å†…å®¹</label>
        <textarea id="formText" rows="6" placeholder="ç²˜è´´ä½ çš„æ‘˜è®°å†…å®¹..."></textarea>
      </div>
      <div class="grid-2">
        <div>
          <label>æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
          <input id="formTags" placeholder="å“²å­¦, è®°å¿†, æ–¹æ³•" />
        </div>
        <div>
          <label>æ—¶é—´ (é»˜è®¤ç°åœ¨)</label>
          <input id="formTime" type="datetime-local" />
        </div>
      </div>
      <div class="row" style="justify-content: flex-end;">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="formSubmit" value="default">ä¿å­˜åˆ°æœ¬åœ°</button>
      </div>
    </form>
  </dialog>

  <!-- æ–°å¢ä¹¦ç›® Modal -->
  <dialog id="dlgBook">
    <div class="modal-head">
      <div>æ–°å¢ä¹¦ç›®</div>
      <button class="btn" onclick="dlgBook.close()">å…³é—­</button>
    </div>
    <form class="modal-body" method="dialog">
      <div class="grid-2">
        <div>
          <label>ä¹¦å</label>
          <input id="formBookTitle" placeholder="ä¹¦å" />
        </div>
        <div>
          <label>ä½œè€… (å¯é€‰)</label>
          <input id="formBookAuthor" placeholder="ä½œè€…" />
        </div>
      </div>
      <div class="row" style="justify-content: flex-end;">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="formBookSubmit" value="default">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <script>
  // =============== è½»é‡ JSONâ€œæ•°æ®åº“â€ç»“æ„ ===============
  // books: [{id, title, author}]
  // notes: [{id, bookId, text, tags:[...], createdAt: ISO, source}]
  // ç”Ÿäº§éƒ¨ç½²å»ºè®®å°†æ•°æ®æ”¾åœ¨ /notes.json å¹¶ç”± fetch è¯»å–ï¼›
  // çº¯é™æ€ç«™ç‚¹å†™å…¥é€šè¿‡ LocalStorage æš‚å­˜ + å¯¼å‡º JSON åˆå¹¶ã€‚

  const SAMPLE_DATA = {
    books: [
      { id: "b-orwell-1984", title: "1984", author: "George Orwell" },
      { id: "b-saracevic-2007", title: "Relevance (Part II)", author: "Tefko Saracevic" },
      { id: "b-nelson-1990", title: "Metamemory: A Theoretical Framework", author: "Nelson" }
    ],
    notes: [
      { id: "n1", bookId: "b-orwell-1984", text: "è‡ªç”±å°±æ˜¯èƒ½å¤Ÿè¯´äºŒåŠ äºŒç­‰äºå››çš„è‡ªç”±ã€‚", tags: ["æ”¿æ²»", "è‡ªç”±"], createdAt: "2021-05-02T12:00:00Z", source: "p.84" },
      { id: "n2", bookId: "b-saracevic-2007", text: "ç›¸å…³æ€§çš„æœ¬è´¨åœ¨äºæƒ…å¢ƒï¼šç”¨æˆ·ã€ä»»åŠ¡ä¸æ—¶é—´ç»´åº¦å…±åŒå†³å®šã€‚", tags: ["Information Science", "Relevance"], createdAt: "2023-11-12T09:30:00Z", source: "Section 3" },
      { id: "n3", bookId: "b-nelson-1990", text: "Feeling of Knowing å¹¶éæ­£ç¡®æ€§çš„ä¿è¯ï¼Œè€Œæ˜¯å¯è¾¾æ€§çš„ä¼°è®¡ã€‚", tags: ["Memory", "FoK"], createdAt: new Date().toISOString(), source: "" }
    ]
  }

  // ------- çŠ¶æ€ -------
  let state = { data: { books:[], notes:[] }, filter: { bookId:null, q:"", sort:"newest", group:"none", view:"all" } }

  // ------- åˆå§‹åŒ–ï¼šä¼˜å…ˆ fetch notes.jsonï¼Œå…¶æ¬¡ LocalStorageï¼Œæœ€å SAMPLE_DATA -------
  async function loadData() {
    const local = localStorage.getItem("my-excerpts-pending")
    let pending = local ? JSON.parse(local) : { books: [], notes: [] }

    try {
      const resp = await fetch("notes.json", { cache: "no-store" })
      if (!resp.ok) throw new Error("no notes.json")
      const server = await resp.json()
      state.data.books = mergeById(server.books || [], pending.books)
      state.data.notes = mergeById(server.notes || [], pending.notes)
    } catch (e) {
      // æ²¡æœ‰ notes.json å°±ç”¨ SAMPLE å¡«å……
      const server = SAMPLE_DATA
      state.data.books = mergeById(server.books || [], pending.books)
      state.data.notes = mergeById(server.notes || [], pending.notes)
    }
  }

  function mergeById(baseArr, addArr) {
    const map = new Map(baseArr.map(x => [x.id, x]))
    for (const item of addArr || []) map.set(item.id, item)
    return [...map.values()]
  }

  // ------- æ¸²æŸ“ -------
  function renderBooks() {
    const root = document.getElementById('bookList')
    root.innerHTML = ''
    const booksSorted = [...state.data.books].sort((a,b)=>a.title.localeCompare(b.title))
    for (const b of booksSorted) {
      const count = state.data.notes.filter(n=>n.bookId===b.id).length
      const el = document.createElement('div')
      el.className = 'book-card' + (state.filter.bookId===b.id?' active':'')
      el.innerHTML = `<div class="row"><div class="book-title">${escapeHTML(b.title)}</div><div class="book-count">${count}</div></div><div class="muted">${escapeHTML(b.author||'')}</div>`
      el.onclick = ()=>{ state.filter.bookId = (state.filter.bookId===b.id? null : b.id); updateURLHash(); renderAll() }
      root.appendChild(el)
    }
  }

  function renderNotes() {
    const content = document.getElementById('content')
    const { q, bookId, sort, group, view } = state.filter

    const qTrim = (q||'').trim()
    const qTags = (qTrim.match(/#[^\s#]+/g)||[]).map(t=>t.slice(1).toLowerCase())
    const qPlain = qTrim.replace(/#[^\s#]+/g,'').toLowerCase()

    // è¿‡æ»¤
    let notes = state.data.notes
      .filter(n => !bookId || n.bookId === bookId)
      .filter(n => {
        if (!qTrim) return true
        const book = state.data.books.find(b=>b.id===n.bookId)
        const hay = [n.text, (n.tags||[]).join(' '), book?.title, book?.author, n.source].join(' ').toLowerCase()
        const matchPlain = qPlain ? hay.includes(qPlain) : true
        const matchTags = qTags.length ? qTags.every(t => (n.tags||[]).map(x=>x.toLowerCase()).includes(t)) : true
        return matchPlain && matchTags
      })

    // å¿«æ·æ—¶é—´è§†å›¾
    const now = new Date()
    notes = notes.filter(n => {
      if (view === 'recent') return (now - new Date(n.createdAt)) <= 7*24*3600*1000
      if (view === 'month') {
        const d = new Date(n.createdAt)
        return d.getUTCFullYear() === now.getUTCFullYear() && d.getUTCMonth() === now.getUTCMonth()
      }
      return true
    })

    // æ’åº
    notes.sort((a,b)=> sort==='newest' ? (new Date(b.createdAt) - new Date(a.createdAt)) : (new Date(a.createdAt) - new Date(b.createdAt)))

    // åˆ†ç»„
    let groups = [{ key: 'all', items: notes }]
    if (group === 'date') {
      const map = new Map()
      for (const n of notes) {
        const d = new Date(n.createdAt)
        const key = d.toISOString().slice(0,10)
        if (!map.has(key)) map.set(key, [])
        map.get(key).push(n)
      }
      groups = [...map.entries()].sort((a,b)=> group==='date' && state.filter.sort==='newest' ? (a[0]<b[0]?1:-1) : (a[0]>b[0]?1:-1)).map(([k,v])=>({key:k, items:v}))
    }
    if (group === 'book') {
      const map = new Map()
      for (const n of notes) {
        const b = state.data.books.find(x=>x.id===n.bookId)
        const key = b ? `${b.title}` : n.bookId
        if (!map.has(key)) map.set(key, [])
        map.get(key).push(n)
      }
      groups = [...map.entries()].sort((a,b)=> a[0].localeCompare(b[0])).map(([k,v])=>({key:k, items:v}))
    }

    content.innerHTML = ''

    if (!notes.length) {
      content.innerHTML = `<div class="empty">æ²¡æœ‰åŒ¹é…çš„æ‘˜è®°ã€‚è¯•è¯•æ›´æ¢ç­›é€‰æˆ–æ·»åŠ æ–°å†…å®¹ï½</div>`
      return
    }

    for (const g of groups) {
      if (group !== 'none') {
        const h = document.createElement('div')
        h.className = 'section-title'
        h.textContent = g.key
        content.appendChild(h)
      }
      for (const n of g.items) content.appendChild(renderNote(n))
    }
  }

  function renderNote(n) {
    const el = document.createElement('div')
    const book = state.data.books.find(b=>b.id===n.bookId)
    const date = new Date(n.createdAt)
    const fmt = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`
    el.className = 'note'
    el.innerHTML = `
      <div class="note-head">
        <div class="tag">${escapeHTML(book?.title||'æœªçŸ¥ä¹¦ç›®')}</div>
        ${n.source? `<div class="tag">${escapeHTML(n.source)}</div>`:''}
        <div class="note-meta">Â· ${fmt}</div>
      </div>
      <div class="note-text">${escapeHTML(n.text)}</div>
      ${(n.tags&&n.tags.length)? `<div class="tags" style="margin-top:8px">${n.tags.map(t=>`<span class='tag'>#${escapeHTML(t)}</span>`).join(' ')}</div>`:''}
    `
    return el
  }

  function renderAll(){ renderBooks(); renderNotes(); fillFormBooks(); }

  // ------- äº‹ä»¶ç»‘å®š -------
  document.getElementById('q').addEventListener('input', e=>{ state.filter.q = e.target.value; updateURLHash(); renderNotes() })
  document.getElementById('sort').addEventListener('change', e=>{ state.filter.sort = e.target.value; updateURLHash(); renderNotes() })
  document.getElementById('group').addEventListener('change', e=>{ state.filter.group = e.target.value; updateURLHash(); renderNotes() })

  document.querySelectorAll('aside [data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ state.filter.view = btn.getAttribute('data-view'); renderNotes() })
  })

  // æ–°å¢æ‘˜è®°
  const dlgNote = document.getElementById('dlgNote')
  document.getElementById('btnNew').onclick = ()=>{ dlgNote.showModal(); document.getElementById('formText').focus() }
  document.getElementById('formSubmit').onclick = (e)=>{
    e.preventDefault()
    const bookId = document.getElementById('formNoteBook').value
    const text = document.getElementById('formText').value.trim()
    const tags = document.getElementById('formTags').value.split(',').map(s=>s.trim()).filter(Boolean)
    const createdAt = document.getElementById('formTime').value ? new Date(document.getElementById('formTime').value).toISOString() : new Date().toISOString()
    const source = document.getElementById('formSource').value.trim()
    if (!bookId || !text) { alert('è¯·é€‰æ‹©ä¹¦ç›®å¹¶å¡«å†™å†…å®¹'); return }
    const note = { id: `n${Date.now()}`, bookId, text, tags, createdAt, source }
    addPending({ notes: [note] })
    dlgNote.close(); renderAll()
  }

  // æ–°å¢ä¹¦ç›®
  const dlgBook = document.getElementById('dlgBook')
  document.getElementById('btnNewBook').onclick = ()=>{ dlgBook.showModal(); document.getElementById('formBookTitle').focus() }
  document.getElementById('formBookSubmit').onclick = (e)=>{
    e.preventDefault()
    const title = document.getElementById('formBookTitle').value.trim()
    const author = document.getElementById('formBookAuthor').value.trim()
    if (!title) { alert('è¯·å¡«å†™ä¹¦å'); return }
    const book = { id: slugId(title), title, author }
    addPending({ books: [book] })
    dlgBook.close(); renderAll()
  }

  function fillFormBooks(){
    const sel = document.getElementById('formNoteBook'); sel.innerHTML = ''
    for (const b of state.data.books.sort((a,b)=>a.title.localeCompare(b.title))) {
      const opt = document.createElement('option'); opt.value = b.id; opt.textContent = `${b.title}${b.author? ' Â· '+b.author:''}`; sel.appendChild(opt)
    }
  }

  // å¯¼å…¥/å¯¼å‡º JSON
  document.getElementById('btnExport').onclick = ()=>{
    const merged = getMergedJSON()
    downloadJSON(merged, 'notes.json')
  }
  document.getElementById('btnImport').onclick = ()=>{
    const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json'
    inp.onchange = async ()=>{
      const file = inp.files?.[0]; if (!file) return
      try {
        const txt = await file.text(); const imported = JSON.parse(txt)
        // è¦†ç›–åˆ° pendingï¼ˆä¸ç›´æ¥è¦†ç›–æœåŠ¡å™¨ï¼Œåªå½±å“æœ¬åœ°ï¼‰
        localStorage.setItem('my-excerpts-pending', JSON.stringify({
          books: imported.books || [],
          notes: imported.notes || []
        }))
        await loadData(); renderAll()
        alert('å·²ä»æ–‡ä»¶å¯¼å…¥åˆ°æœ¬åœ°ï¼ˆLocalStorageï¼‰ã€‚å¦‚éœ€å‘å¸ƒï¼Œè¯·ä½¿ç”¨â€œå¯¼å‡ºJSONâ€å†ä¸Šä¼ åˆ°æœåŠ¡å™¨è¦†ç›–ã€‚')
      } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message) }
    }
    inp.click()
  }

  function getMergedJSON(){
    // å°†å½“å‰å†…å­˜ä¸­çš„æ•°æ®æ‰“åŒ…å¯¼å‡º
    return { books: state.data.books, notes: state.data.notes }
  }

  function addPending(partial){
    const local = localStorage.getItem('my-excerpts-pending')
    const pending = local ? JSON.parse(local) : { books: [], notes: [] }
    if (partial.books) pending.books = mergeById(pending.books, partial.books)
    if (partial.notes) pending.notes = mergeById(pending.notes, partial.notes)
    localStorage.setItem('my-excerpts-pending', JSON.stringify(pending))
    // åŒæ­¥åˆ°å†…å­˜
    if (partial.books) state.data.books = mergeById(state.data.books, partial.books)
    if (partial.notes) state.data.notes = mergeById(state.data.notes, partial.notes)
  }

  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'})
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click()
    setTimeout(()=>URL.revokeObjectURL(url), 500)
  }

  // URL Hash åŒæ­¥ï¼š#book=...&q=...
  function updateURLHash(){
    const p = new URLSearchParams()
    if (state.filter.bookId) p.set('book', state.filter.bookId)
    if (state.filter.q) p.set('q', state.filter.q)
    if (state.filter.sort!== 'newest') p.set('sort', state.filter.sort)
    if (state.filter.group!== 'none') p.set('group', state.filter.group)
    const s = p.toString(); location.hash = s ? '#' + s : ''
  }
  function readURLHash(){
    const p = new URLSearchParams(location.hash.slice(1))
    state.filter.bookId = p.get('book') || null
    state.filter.q = p.get('q') || ''
    state.filter.sort = p.get('sort') || 'newest'
    state.filter.group = p.get('group') || 'none'
    document.getElementById('q').value = state.filter.q
    document.getElementById('sort').value = state.filter.sort
    document.getElementById('group').value = state.filter.group
  }
  window.addEventListener('hashchange', ()=>{ readURLHash(); renderAll() })

  // å·¥å…·
  function slugId(s){ return 'b-' + s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') }
  function escapeHTML(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])) }

  // å¯åŠ¨
  (async function(){
    readURLHash();
    await loadData();
    renderAll();
  })()
  </script>
</body>
</html>
